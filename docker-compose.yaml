version: '3.8'

# ============================================================
# PRODUCTION — All config sourced from .env
# ============================================================
# Required .env variables:
#   MONGO_ROOT_USER, MONGO_ROOT_PASSWORD
#   MONGO_APP_USER,  MONGO_APP_PASSWORD
#   MONGO_DB_NAME,   DATABASE_URL
#   REDIS_PASSWORD,  REDIS_HOST, REDIS_PORT
#   BACKUP_RETAIN_DAYS
# ============================================================

services:
  # ─────────────────────────────────────────
  # MONGODB REPLICA SET (3 nodes)
  # ─────────────────────────────────────────

  mongo1:
    image: mongo:7.0
    container_name: sofiajamale_mongo1
    hostname: mongo1
    restart: unless-stopped
    command: mongod --replSet rs0 --bind_ip_all --port 27017 --keyFile /etc/mongodb/keyfile/mongo-keyfile --auth --wiredTigerCacheSizeGB 1
    expose:
      - '27017'
    env_file: .env
    environment:
      MONGO_INITDB_ROOT_USERNAME: ${MONGO_ROOT_USER}
      MONGO_INITDB_ROOT_PASSWORD: ${MONGO_ROOT_PASSWORD}
    volumes:
      - mongo1_data:/data/db
      - mongo1_config:/data/configdb
      - ./mongodb/keyfile/mongo-keyfile:/etc/mongodb/keyfile/mongo-keyfile:ro
      - ./mongodb/config/mongod.conf:/etc/mongod.conf:ro
      - mongo1_logs:/var/log/mongodb
    networks:
      - mongo_network
      - backend_network
    healthcheck:
      test: mongosh --quiet --eval "db.adminCommand('ping').ok" --username ${MONGO_ROOT_USER} --password ${MONGO_ROOT_PASSWORD} --authenticationDatabase admin
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 40s
    deploy:
      resources:
        limits: { cpus: '1.0', memory: 1.5G }
        reservations: { cpus: '0.5', memory: 512M }
    logging:
      driver: json-file
      options: { max-size: '50m', max-file: '5' }

  mongo2:
    image: mongo:7.0
    container_name: sofiajamale_mongo2
    hostname: mongo2
    restart: unless-stopped
    command: mongod --replSet rs0 --bind_ip_all --port 27017 --keyFile /etc/mongodb/keyfile/mongo-keyfile --auth --wiredTigerCacheSizeGB 1
    expose:
      - '27017'
    env_file: .env
    environment:
      MONGO_INITDB_ROOT_USERNAME: ${MONGO_ROOT_USER}
      MONGO_INITDB_ROOT_PASSWORD: ${MONGO_ROOT_PASSWORD}
    volumes:
      - mongo2_data:/data/db
      - mongo2_config:/data/configdb
      - ./mongodb/keyfile/mongo-keyfile:/etc/mongodb/keyfile/mongo-keyfile:ro
      - ./mongodb/config/mongod.conf:/etc/mongod.conf:ro
      - mongo2_logs:/var/log/mongodb
    networks:
      - mongo_network
      - backend_network
    depends_on: [mongo1]
    deploy:
      resources:
        limits: { cpus: '1.0', memory: 1.5G }
        reservations: { cpus: '0.5', memory: 512M }
    logging:
      driver: json-file
      options: { max-size: '50m', max-file: '5' }

  mongo3:
    image: mongo:7.0
    container_name: sofiajamale_mongo3
    hostname: mongo3
    restart: unless-stopped
    command: mongod --replSet rs0 --bind_ip_all --port 27017 --keyFile /etc/mongodb/keyfile/mongo-keyfile --auth --wiredTigerCacheSizeGB 1
    expose:
      - '27017'
    env_file: .env
    environment:
      MONGO_INITDB_ROOT_USERNAME: ${MONGO_ROOT_USER}
      MONGO_INITDB_ROOT_PASSWORD: ${MONGO_ROOT_PASSWORD}
    volumes:
      - mongo3_data:/data/db
      - mongo3_config:/data/configdb
      - ./mongodb/keyfile/mongo-keyfile:/etc/mongodb/keyfile/mongo-keyfile:ro
      - ./mongodb/config/mongod.conf:/etc/mongod.conf:ro
      - mongo3_logs:/var/log/mongodb
    networks:
      - mongo_network
      - backend_network
    depends_on: [mongo1]
    deploy:
      resources:
        limits: { cpus: '1.0', memory: 1.5G }
        reservations: { cpus: '0.5', memory: 512M }
    logging:
      driver: json-file
      options: { max-size: '50m', max-file: '5' }

  # Initializes replica set + creates app user (runs once, exits)
  mongo-init:
    image: mongo:7.0
    container_name: sofiajamale_mongo_init
    restart: 'no'
    depends_on:
      mongo1: { condition: service_healthy }
      mongo2: { condition: service_started }
      mongo3: { condition: service_started }
    env_file: .env
    volumes:
      - ./mongodb/scripts/init-replicaset.sh:/init-replicaset.sh:ro
    networks:
      - mongo_network
    entrypoint: ['bash', '/init-replicaset.sh']

  # Daily automated backup sidecar (cron at 02:00 UTC)
  mongo-backup:
    image: mongo:7.0
    container_name: sofiajamale_mongo_backup
    restart: unless-stopped
    depends_on:
      mongo1: { condition: service_healthy }
    env_file: .env
    volumes:
      - ./mongodb/scripts/backup.sh:/backup.sh:ro
      - mongo_backups:/backups
    networks:
      - mongo_network
    entrypoint: ['bash', '/backup.sh', 'cron']
    logging:
      driver: json-file
      options: { max-size: '10m', max-file: '3' }

  # ─────────────────────────────────────────
  # REDIS
  # ─────────────────────────────────────────

  redis:
    image: redis:7-alpine
    container_name: sofiajamale_redis
    restart: unless-stopped
    # Password sourced from .env REDIS_PASSWORD via shell substitution
    command: >
      sh -c "redis-server
      --requirepass $$REDIS_PASSWORD
      --appendonly yes
      --appendfsync everysec
      --save 900 1
      --save 300 10
      --save 60 10000
      --maxmemory 512mb
      --maxmemory-policy allkeys-lru"
    expose:
      - '6379'
    env_file: .env
    volumes:
      - redis_data:/data
    networks:
      - backend_network
    healthcheck:
      test:
        [
          'CMD',
          'sh',
          '-c',
          'redis-cli -a $$REDIS_PASSWORD --no-auth-warning ping',
        ]
      interval: 10s
      timeout: 3s
      retries: 5
    deploy:
      resources:
        limits: { cpus: '0.5', memory: 600M }
        reservations: { cpus: '0.25', memory: 256M }
    logging:
      driver: json-file
      options: { max-size: '20m', max-file: '5' }

  # ─────────────────────────────────────────
  # APPLICATION SERVER
  # ─────────────────────────────────────────

  server:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: sofiajamale_server
    restart: unless-stopped
    expose:
      - '5000'
    env_file: .env
    environment:
      # These override .env values to force correct service-mesh values
      NODE_ENV: production
      PORT: '5000'
      REDIS_HOST: redis # container name, not localhost
    networks:
      - backend_network
    depends_on:
      redis: { condition: service_healthy }
      mongo1: { condition: service_healthy }
    healthcheck:
      test:
        [
          'CMD',
          'wget',
          '--no-verbose',
          '--tries=1',
          '--spider',
          'http://localhost:5000/health',
        ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    stop_grace_period: 30s
    deploy:
      resources:
        limits: { cpus: '1.0', memory: 1G }
        reservations: { cpus: '0.5', memory: 512M }
    logging:
      driver: json-file
      options: { max-size: '50m', max-file: '5' }

  # ─────────────────────────────────────────
  # NGINX
  # ─────────────────────────────────────────

  nginx:
    image: nginx:alpine
    container_name: sofiajamale_nginx
    restart: unless-stopped
    ports:
      - '80:80'
      - '443:443'
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf:ro
      - ./ssl:/etc/nginx/ssl:ro
      - nginx_logs:/var/log/nginx
    networks:
      - backend_network
    depends_on:
      server: { condition: service_healthy }
    logging:
      driver: json-file
      options: { max-size: '20m', max-file: '5' }

networks:
  backend_network:
    name: sofiajamale_backend
    driver: bridge
  mongo_network:
    name: sofiajamale_mongo
    driver: bridge

volumes:
  mongo1_data: { name: sofiajamale_mongo1_data }
  mongo1_config: { name: sofiajamale_mongo1_config }
  mongo1_logs: { name: sofiajamale_mongo1_logs }
  mongo2_data: { name: sofiajamale_mongo2_data }
  mongo2_config: { name: sofiajamale_mongo2_config }
  mongo2_logs: { name: sofiajamale_mongo2_logs }
  mongo3_data: { name: sofiajamale_mongo3_data }
  mongo3_config: { name: sofiajamale_mongo3_config }
  mongo3_logs: { name: sofiajamale_mongo3_logs }
  mongo_backups: { name: sofiajamale_mongo_backups }
  redis_data: { name: sofiajamale_redis_data }
  nginx_logs: { name: sofiajamale_nginx_logs }
